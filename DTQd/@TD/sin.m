function res=sin(a)
% written by P. B. Du & H. Jiang NUDT 07/01/2013

% To compute sin(x); we choose integers a, b so that
% 
%        x = s + a * (pi/2) + b * (pi/256)
% 
%      and |s| <= pi/512.  Using a precomputed table of
%      sin(k pi / 256) and cos(k pi / 256); we can compute
%      sin(x) from sin(s) and cos(s).  This greatly increases the
%      convergence of the sine Taylor series.

%  Table of sin(k * pi/256) and cos(k * pi/256)
sin_table(1)=TD( 1.2271538285719925e-02, 6.9197907640283170e-19, -4.0203726713435555e-36);
sin_table(2)=TD( 2.4541228522912288e-02, -9.1868490125778782e-20, 4.8706148704467061e-36);
sin_table(3)=TD( 3.6807222941358832e-02, 6.1060088803529842e-19, -4.0448721259852727e-35);
sin_table(4)=TD( 4.9067674327418015e-02, -6.7961037205182801e-19, -4.4318868124718325e-35);
sin_table(5)=TD( 6.1320736302208578e-02, -5.1181134064638108e-19, -4.2726335866706313e-35);
sin_table(6)=TD( 7.3564563599667426e-02, -2.7784941506273593e-18, -9.1240375489852821e-35);
sin_table(7)=TD( 8.5797312344439894e-02, -3.3881893830684029e-18, -1.6135529531508258e-34);
sin_table(8)=TD( 9.8017140329560604e-02, -1.6345823622442560e-18, -1.3209238810006454e-35);
sin_table(9)=TD( 1.1022220729388306e-01, -5.6789503537823233e-19, 1.0380274792383233e-35);
sin_table(10)=TD( 1.2241067519921620e-01, 2.8354501489965335e-18, 1.8151655751493305e-34);
sin_table(11)=TD( 1.3458070850712620e-01, -9.1670359171480699e-18, 1.5916493007073973e-34);
sin_table(12)=TD( 1.4673047445536175e-01, 3.7269471470465677e-18, 3.7352398151250827e-34);
sin_table(13)=TD( 1.5885814333386145e-01, -4.0163200573859079e-18,  -9.2840580257628812e-35);
sin_table(14)=TD( 1.7096188876030122e-01, 9.1919980181759094e-18,  -6.7688743940982606e-34);
sin_table(15)=TD( 1.8303988795514095e-01, 7.7349918688637383e-18,  -4.4803769968145083e-34);
sin_table(16)=TD( 1.9509032201612828e-01, -7.9910790684617313e-18,  6.1846270024220713e-34);
sin_table(17)=TD( 2.0711137619221856e-01, -1.0613362528971356e-17,  2.2456805112690884e-34);
sin_table(18)=TD( 2.1910124015686980e-01, -3.6513812299150776e-19,  -2.3359499418606442e-35);
sin_table(19)=TD( 2.3105810828067111e-01, 1.0129787149761869e-17,    -6.9359234615816044e-34);
sin_table(20)=TD( 2.4298017990326390e-01, -8.7514315297196632e-18,    -6.5723260373079431e-34);
sin_table(21)=TD( 2.5486565960451457e-01, -1.3602299806901461e-19,       -6.0073844642762535e-36);
sin_table(22)=TD( 2.6671275747489837e-01, 2.0941222578826688e-17,       -1.1303466524727989e-33);
sin_table(23)=TD( 2.7851968938505312e-01, -1.0030273719543544e-17,       7.2592115325689254e-34);
sin_table(24)=TD( 2.9028467725446239e-01, -1.8927978707774251e-17,       1.1522953157142315e-33);
sin_table(25)=TD( 3.0200594931922808e-01, -1.7167666235262474e-17,       2.3336182149008069e-34);
sin_table(26)=TD( 3.1368174039889146e-01, 1.4560447299968912e-17,       3.6564186898011595e-34);
sin_table(27)=TD( 3.2531029216226293e-01, 7.9171249463765892e-18,      -6.7576622068146391e-35);
sin_table(28)=TD( 3.3688985339222005e-01, -4.2000940033475092e-19,       -2.9178652969985438e-36);
sin_table(29)=TD( 3.4841868024943456e-01, 3.6974420514204918e-18,       3.5532146878499996e-34);
sin_table(30)=TD( 3.5989503653498817e-01, -1.7601687123839282e-17,       1.3375125473046791e-33);
sin_table(31)=TD( 3.7131719395183754e-01, 3.4749239648238266e-19,       -7.5151053042866671e-37);
sin_table(32)=TD( 3.8268343236508978e-01, -1.0050772696461588e-17,       -2.0605316302806695e-34);
sin_table(33)=TD( 3.9399204006104810e-01, 9.7649241641239336e-18,       -2.1233599441284617e-34);
sin_table(34)=TD( 4.0524131400498986e-01, 9.9111401942899884e-18,       -2.5169070895434648e-34);
sin_table(35)=TD( 4.1642956009763721e-01, -2.5475580413131732e-17,       -3.4482678506112824e-34);
sin_table(36)=TD( 4.2755509343028208e-01, 9.4111898162954726e-18,       -1.7446682426598801e-34);
sin_table(37)=TD( 4.3861623853852766e-01, -2.0883315831075090e-17,       -1.4259583540891877e-34);
sin_table(38)=TD( 4.4961132965460660e-01, 4.8831924232035243e-18,       2.7151084498191381e-34);
sin_table(39)=TD( 4.6053871095824001e-01, 1.8488777492177872e-17,       -1.0527732154209725e-33);
sin_table(40)=TD( 4.7139673682599764e-01, 6.5166781360690130e-18,       2.9457546966235984e-34);
sin_table(41)=TD( 4.8218377207912277e-01, -2.5861500925520442e-17,       -6.2913197606500007e-36);
sin_table(42)=TD( 4.9289819222978404e-01, -1.0257831676562186e-18,       6.9520817760885069e-35);
sin_table(43)=TD( 5.0353838372571758e-01, -1.6731308204967497e-17,       -1.0140233644074786e-33);
sin_table(44)=TD( 5.1410274419322177e-01, -4.5712707523615624e-17,       1.5488279442238283e-33);
sin_table(45)=TD( 5.2458968267846895e-01, -4.3068869040082345e-17,       -4.2013155291932055e-34);
sin_table(46)=TD( 5.3499761988709726e-01, -5.3683132708358134e-17,       -1.3900569918838112e-33);
sin_table(47)=TD( 5.4532498842204646e-01, -4.1517817538384258e-17,       -1.5318930219385941e-33);
sin_table(48)=TD( 5.5557023301960218e-01, 4.7094109405616768e-17,       -2.0640520383682921e-33);
sin_table(49)=TD( 5.6573181078361323e-01, -3.4096079596590466e-17,       -1.7073289744303546e-33);
sin_table(50)=TD( 5.7580819141784534e-01, -3.7909495458942734e-17,       -2.7433738046854309e-33);
sin_table(51)=TD( 5.8579785745643886e-01, -3.7485501964311294e-18,       2.7965403775536614e-34);
sin_table(52)=TD( 5.9569930449243336e-01, -1.3438641936579467e-17,       -6.7877687907721049e-35);
sin_table(53)=TD( 6.0551104140432555e-01, -3.1202672493305677e-17,      1.2761267338680916e-33);
sin_table(54)=TD( 6.1523159058062682e-01, 2.6231417767266950e-17,       -1.4095366621106716e-33);
sin_table(55)=TD( 6.2485948814238634e-01, 3.3671846037243900e-17,      -2.7846053391012096e-33);
sin_table(56)=TD( 6.3439328416364549e-01, 1.0420901929280035e-17,       4.1174558929280492e-34);
sin_table(57)=TD( 6.4383154288979150e-01, -3.2084798795046886e-17,       -1.2595311907053305e-33);
sin_table(58)=TD( 6.5317284295377676e-01, 8.5695642060026238e-18,       -6.9165322305070633e-34);
sin_table(59)=TD( 6.6241577759017178e-01, -2.2615508885764591e-17,       5.0177050318126862e-34);
sin_table(60)=TD( 6.7155895484701844e-01, -4.0489037749296692e-17,       3.1995835625355681e-34);
sin_table(61)=TD( 6.8060099779545302e-01, 2.8473293354522047e-17,       4.1331805977270903e-34);
sin_table(62)=TD( 6.8954054473706694e-01, -1.5889323294806790e-17,      9.1242356240205712e-34);
sin_table(63)=TD( 6.9837624940897280e-01, 4.8988282435667768e-17,      1.9134010413244152e-33);
sin_table(64)=TD( 7.0710678118654757e-01, -4.8336466567264567e-17,     2.0693376543497068e-33);
       
     
cos_table(1)=TD( 9.9992470183914450e-01, 3.7931082512668012e-17,       -8.5099918660501484e-35);
cos_table(2)=TD( 9.9969881869620425e-01, -2.9851486403799753e-17,       -1.9084787370733737e-33);
cos_table(3)=TD( 9.9932238458834954e-01, -4.2858538440845682e-17,      3.3235101605146565e-34);
cos_table(4)=TD( 9.9879545620517241e-01, -1.2291693337075465e-17,       2.4468446786491271e-34);
cos_table(5)=TD( 9.9811811290014918e-01, 2.7935487558113833e-17,       2.4423341255830345e-33);
cos_table(6)=TD( 9.9729045667869021e-01, 9.1647695371101735e-18,       6.7824134309739296e-34);
cos_table(7)=TD( 9.9631261218277800e-01, 1.1336497891624735e-17,       3.4002458674414360e-34);
cos_table(8)=TD( 9.9518472667219693e-01, -4.2486913678304410e-17,       1.3315510772504614e-33);
cos_table(9)=TD( 9.9390697000235606e-01, -1.8964849471123746e-17,       -1.5980853777937752e-35);
cos_table(10)=TD( 9.9247953459870997e-01, 3.1093055095428906e-17,       -1.8379594757818019e-33);
cos_table(11)=TD( 9.9090263542778001e-01, 1.5394565094566704e-17,       -1.0799984133184567e-33);
cos_table(12)=TD( 9.8917650996478101e-01, -4.0987309937047111e-17,       -4.4857560552048437e-34);
cos_table(13)=TD( 9.8730141815785843e-01, -5.2332261255715652e-17,       -2.7937644333152473e-33);
cos_table(14)=TD( 9.8527764238894122e-01, 2.3155637027900207e-17,       -7.5275971545764833e-34);
cos_table(15)=TD( 9.8310548743121629e-01, 4.2170007522888628e-17,       8.2396265656440904e-34);
cos_table(16)=TD( 9.8078528040323043e-01, 1.8546939997825006e-17,       -1.0696564445530757e-33);
cos_table(17)=TD( 9.7831737071962765e-01, -2.1623082233344895e-17,       1.0970403012028032e-33);
cos_table(18)=TD( 9.7570213003852857e-01, -2.5572556081259686e-17,       -9.3174244508942223e-34);
cos_table(19)=TD( 9.7293995220556018e-01, -3.1311211122281800e-17,       -2.6874087789006141e-33);
cos_table(20)=TD( 9.7003125319454397e-01, 1.8365300348428844e-17,       -1.4311097571944918e-33);
cos_table(21)=TD( 9.6697647104485207e-01, 3.8496228837337864e-17,       -5.3881631542745647e-34);
cos_table(22)=TD( 9.6377606579543984e-01, 2.6463950561220029e-17,       -2.9073234590199323e-36);
cos_table(23)=TD( 9.6043051941556579e-01, 2.4653904815317185e-17,       -1.3792169410906322e-33);
cos_table(24)=TD( 9.5694033573220882e-01, 4.0553869861875701e-17,       -1.7147013364302149e-33);
cos_table(25)=TD( 9.5330604035419386e-01, -2.5190738779919934e-17,       -1.4272239821134379e-33);
cos_table(26)=TD( 9.4952818059303667e-01, -7.5544151928043298e-18,       -5.1260245024046686e-34);
cos_table(27)=TD( 9.4560732538052128e-01, 4.6019102478523738e-17,       -6.2534384769452059e-34);
cos_table(28)=TD( 9.4154406518302081e-01, -2.7896379547698341e-17,       1.6273236356733898e-33);
cos_table(29)=TD( 9.3733901191257496e-01, -3.6570926284362776e-17,       -1.1902940071273247e-33);
cos_table(30)=TD( 9.3299279883473885e-01, 4.2041415555384355e-17,       9.0285896495521276e-34);
cos_table(31)=TD( 9.2850608047321559e-01, -2.3306639848485943e-17,       -7.7799084333208503e-34);
cos_table(32)=TD( 9.2387953251128674e-01, 1.7645047084336677e-17,       -5.0442537321586818e-34);
cos_table(33)=TD( 9.1911385169005777e-01, -2.6496484622344718e-17,       6.5403604763461920e-34);
cos_table(34)=TD( 9.1420975570353069e-01, -3.6316182527814423e-17,       -1.9438819777122554e-33);
cos_table(35)=TD( 9.0916798309052238e-01, -3.6878564091359894e-18,       2.9951330310507693e-34);
cos_table(36)=TD( 9.0398929312344334e-01, -6.6097544687484308e-18,       1.2728013034680357e-34);
cos_table(37)=TD( 8.9867446569395382e-01, 2.6316906461033013e-17,       3.7003137047796840e-35);
cos_table(38)=TD( 8.9322430119551532e-01, -4.1161239151908913e-18,       2.5380253805715999e-34);
cos_table(39)=TD( 8.8763962040285393e-01, 1.2805091918587960e-17,       3.9948742059584459e-35);
cos_table(40)=TD( 8.8192126434835505e-01, -1.9843248405890562e-17,       -7.0412114007673834e-34);
cos_table(41)=TD( 8.7607009419540660e-01, 5.8729024235147677e-18,       2.7941144391738458e-34);
cos_table(42)=TD( 8.7008699110871146e-01, -4.1888510868549968e-17,       7.0900185861878415e-34);
cos_table(43)=TD( 8.6397285612158670e-01, 4.1486355957361607e-17,      2.2709976932210266e-33);
cos_table(44)=TD( 8.5772861000027212e-01, -4.8183447936336620e-17,       -1.1044130517687532e-33);
cos_table(45)=TD( 8.5135519310526520e-01, -5.3279874446016209e-17,       2.2281156380919942e-33);
cos_table(46)=TD( 8.4485356524970712e-01, -4.3631360296879637e-17,       -2.0307726853367547e-33);
cos_table(47)=TD( 8.3822470555483808e-01, -3.5560085052855026e-17,       1.1689791577022643e-33);
cos_table(48)=TD( 8.3146961230254524e-01, 1.4073856984728024e-18,       4.6951315383980830e-35);
cos_table(49)=TD( 8.2458930278502529e-01, -2.6512360488868275e-17,       1.6916964350914386e-34);
cos_table(50)=TD( 8.1758481315158371e-01, -1.4883149812426772e-17,       -7.8273262771298917e-34);
cos_table(51)=TD( 8.1045719825259477e-01, 2.3520367349840499e-17,       -7.7530070904846341e-34);
cos_table(52)=TD( 8.0320753148064494e-01, -3.3060609804814910e-17,       -1.2242726252420433e-33);
cos_table(53)=TD( 7.9583690460888357e-01, -3.0062724851910721e-17,       -2.2496210832042235e-33);
cos_table(54)=TD( 7.8834642762660623e-01, 3.4396993154059708e-17,       1.7710623746737170e-33);
cos_table(55)=TD( 7.8073722857209449e-01, -9.9198782066678806e-18,       -2.1265794012162715e-36);
cos_table(56)=TD( 7.7301045336273699e-01, -3.2565907033649772e-17,       1.3860807251523929e-33);
cos_table(57)=TD( 7.6516726562245896e-01, -3.2707225612534598e-17,       1.1177117747079528e-33);
cos_table(58)=TD( 7.5720884650648457e-01, -1.9909098777335502e-17,       3.9409283266158482e-34);
cos_table(59)=TD( 7.4913639452345937e-01, -4.4729078447011889e-17,       -2.4206025249983768e-33);
cos_table(60)=TD( 7.4095112535495911e-01, -1.4708616952297345e-17,       -4.9550433827142032e-34);
cos_table(61)=TD( 7.3265427167241282e-01, 1.8918673481573520e-17,       -1.5123719544119886e-33);
cos_table(62)=TD( 7.2424708295146689e-01, 2.9198471334403004e-17,      2.3027324968739464e-33);
cos_table(63)=TD( 7.1573082528381871e-01, -5.1581018476410262e-17,       -1.3736271349300259e-34);
cos_table(64)=TD( 7.0710678118654757e-01, -4.8336466567264567e-17,       2.0693376543497068e-33);     


td_2pi = TD(6.283185307179586232e+00,2.449293598294706414e-16, -5.989539619436679332e-33);
td_pi2 = TD(1.570796326794896558e+00, 6.123233995736766036e-17, -1.497384904859169833e-33);
td_pi256 = TD(1.227184630308513e-02, 4.783776559169348e-19, -1.169831956921226e-35); %这个是通过QD算出来的，每个数都少了最后3位，不过应该够用了

if a.complex
    error('we only consider real number now');
end

if iszero(a)
      res=TD(0);
      return
end

% approximately reduce modulo 2*pi
% z=nint(a/dd_2pi);
z=round(a./td_2pi);
r=a-td_2pi.*z;

% approximately reduce modulo pi/2 and then modulo pi/256
q=floor(r.p1./td_pi2.p1+0.5);
t=r-td_pi2.*q;
j=round(q);
q=floor(t.p1./td_pi256.p1+0.5);
t=t-td_pi256.*q;
k=round(q);
abs_k=abs(k);

if(j<-2||j>2)
    error('Cannot reduce modulo pi/2');
end

if(abs_k>64)
    error('Cannot reduce modulo pi/256');
end

if(k==0)
    switch(j)
        case 0
            res=sin_taylor(t);
            return
        case 1
            res=cos_taylor(t);
            return
        case -1
            res=-cos_taylor(t);
            return
        otherwise
            res=-sin_taylor(t);
            return
    end
end

u=cos_table(abs_k);
v=sin_table(abs_k);
[sin_t,cos_t]=sincos_taylor(t);
if(j==0)
    if(k>0)
        r=u.*sin_t+v.*cos_t;
    else
        r=u.*sin_t-v.*cos_t;
    end
elseif(j==1)
        if(k>0)
            r=u.*cos_t-v.*sin_t;
        else
            r=u.*cos_t+v.*sin_t;
        end
elseif(j==-1)
            if(k>0)
                r=v.*sin_t-u.*cos_t;
            else
                r=-u.*cos_t-v.*sin_t;
            end
else
            if(k>0)
                r=-u.*sin_t-v.*cos_t;
            else
                r=v.*cos_t-u.*sin_t;
            end
end

res=r;